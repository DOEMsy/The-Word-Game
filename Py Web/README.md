## 开发日记

* 2021.1.25
  * 近期目标
    * [x] 将玩家1从服务端分离
    * [x] 改使用 json 传输信息
    * [x] 制定 json 规则	
    * [x] 手造消息队列
    * [x] 协程轮询接收 socket 消息
* 2021.1.26
  * 加入 TCP 消息缓冲队列
  * 重构三层出牌函数
  * TCP 传输改用 Json 数据包
* 2021.1.27
  * 制定 json 传输规则
  * 近期目标：
    * [ ] 完善Mod开发手册
    * [ ] 完善客户端开发手册
    * [ ] 实现技能卡牌相关功能
* 2021.1.28
  * 补充通信规则
  * 近期目标：
    * [ ] 实现技能卡牌相关功能
      * [ ] 完善事件系统（事件驱动模型 ）
        * [ ] 公共监视器
        * [ ] 独立监视器



## 服务端数据通信规则 *v0.1.0*

服务器开放有两个端口 指令通信端口 和 屏幕通信端口

> 两个玩家共用一套通信端口，但拥有各自独立的通信Channel

### 指令通信

频繁传输处理短小的指令，作为客户端和服务器相互通信的主要手段，

由 指令通信端口 `27015` 发送和接受，数据包采用 json ，有特定结构

```json
{
	"ins":"",
	"para":[
   		"",
        "",
        ...
    ]
}
```

* `ins` 项为字符串，表示指令串
* `para` 项为字符串数组，表示指令串尾随的参数们 



#### inp

出牌信号，由服务器向客户端发送，表示客户端可以出牌，并反馈出牌步骤

发出信号后，服务器将接收处理最近一次的 pop 或者 giveup 信号

```json
{
    "ins":"inp",
	"para":[
        "轮到你了，请出牌",
        "0"
    ]
}
```

* `para[0]` 为服务器自然语言反馈
* `para[1]` 表示上次出牌是否错误，0 = False，>0 = True



#### end

游戏结束信号，由服务器向客户端发送，表示游戏结束

```json
{
    "ins":"end",
    "para":[
        "游戏结束",
        "0"
    ]
}
```

* `para[0]` 为服务器自然语言反馈
* `para[1]` 表示胜利方，0 = 玩家1，1 = 玩家2 ，2 = 平局，3 = 错误



#### scr

屏幕通信信号，由服务器向客户端发送，表示游戏对局屏幕发生改变，需要更新

```json
{
    "ins":"scr",
    "para":[]
}
```

在发出信号同时服务器会发送 屏幕通信包



#### prt

显示通信信号，由服务器向客户端发送，包含一些提示信息

```json
{
    "ins":"prt",
    "para":[
        "请调整下眉毛位置",
        ...
    ]
}
```



#### pop

出牌信号，在客户端接收到 inp 信号后可以发送一次，与 giveup 冲突，由客户端向服务器发送，表示出牌步骤，服务器将处理反馈是否合法

不和法的出牌步骤将无效，并再次向客户端发送一次 inp 信号

```json
{
    "ins":"pop",
    "para":[
        "0",
        "UnitCard",
        "1",
        ...
    ]
}
```

* `para[0]` 表示被出牌在手牌中的下标
* `para[1]` 表示被出牌的类型
* `para[2: ]` 表示出牌步骤，不同类型的卡牌有不同的出牌步骤规则



#### giveup

弃权信号，在客户端接收到 inp 信号后可以发送一次，与 pop 冲突，由客户端向服务器发送，表示弃权本场对局（一共三场，三局两胜）

```json
{
    "ins":"giveup",
    "para":[]
}
```



### 屏幕通信

由  屏幕通信端口 `27016` 发送，*本端口可以接收数据，但不会做任何处理*

#### 对局包

由服务器发出，较大的数据包，其中包括一整套的对局当前信息和屏幕信息

服务器在发出 对局包 前会提前发送 scr 信号

```json
{	
    "scr":"",
    "dic":{
        
    }
}
```

* `scr`  项为字符串，是游戏对局屏幕的字符画形式，可以直接输出在屏幕上作为客户端屏幕显示
* `dic` 项为字典，其中包括了全部游戏对局的信息

#### scr 示例

```
3: 
2: 
1: 
-----------NA:Player1 CO:0, HE:3 GV:False CP:10 ----------
Night
Gl: 
-----------NA:Player2 CO:0, HE:3 GV:False CP:10 ----------
1: 
2: 
3: 
It's you turn
You are Player2 now，Board 0
HandCards:
0. [UnitCard,哥布林,2,1,小型的野生哥布林，是一种常见的魔物],
1. [UnitCard,帝国老兵,3,1,一名普普通通的士兵，本本分分的谋生],
2. [UnitCard,哥布林,2,1,小型的野生哥布林，是一种常见的魔物],
3. [UnitCard,哥布林,2,1,小型的野生哥布林，是一种常见的魔物],
4. [UnitCard,哥布林,2,1,小型的野生哥布林，是一种常见的魔物],
5. [UnitCard,帝国老兵,3,1,一名普普通通的士兵，本本分分的谋生],
6. [UnitCard,帝国老兵,3,1,一名普普通通的士兵，本本分分的谋生],
7. [UnitCard,帝国老兵,3,1,一名普普通通的士兵，本本分分的谋生],
8. [UnitCard,哥布林,2,1,小型的野生哥布林，是一种常见的魔物],
9. [UnitCard,哥布林,2,1,小型的野生哥布林，是一种常见的魔物],
```



#### dic 示例

```json
{
    "GlobalEffect":[],
    "DayOrNight":true,
    "NumberOfBoard":0,
    "PlayCardQueue": [],
    "Player":[
        {
            "HandCards":[],
            "RawPileSize":20,
            "UnitGrave":[],
            "Lines":[[],[],[]],
            "Name":"Msy",
            "NO":0,
            "Health":3,
            "TolCombat":0
        },
        {
            "HandCards":[],
            "RawPileSize":20,
            "UnitGrave":[],
            "Lines":[[],[],[]],
            "Name":"BladeHiker",
            "NO":1,
            "Health":3,
            "TolCombat":0
        }
    ],
    "YourNum":0,
}
```

